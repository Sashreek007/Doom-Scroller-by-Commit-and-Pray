import{c as be,e as X}from"./profile-DccX_sEz.js";import{t as D,a as Te}from"./constants-BqRKAH88.js";const R="scrollBatches",C="scrollBatchesInFlight";let p=new Map,f=new Map;function A(e){return{...e}}function E(e,s){for(const t of s){const o=e.get(t.site);o?(o.totalPixels+=t.totalPixels,o.totalMeters+=t.totalMeters,o.sessionStart=Math.min(o.sessionStart,t.sessionStart),o.lastUpdate=Math.max(o.lastUpdate,t.lastUpdate)):e.set(t.site,A(t))}}function j(e){if(!e||typeof e!="object")return new Map;const s=Object.entries(e);return new Map(s.map(([t,o])=>[t,A(o)]))}function Ae(e,s,t){const o=p.get(e);o?(o.totalPixels+=s,o.totalMeters+=t,o.lastUpdate=Date.now()):p.set(e,{site:e,totalPixels:s,totalMeters:t,sessionStart:Date.now(),lastUpdate:Date.now()}),w()}async function w(){await chrome.storage.local.set({[R]:Object.fromEntries(p),[C]:Object.fromEntries(f)})}async function Ee(){const e=await chrome.storage.local.get([R,C]);p=j(e[R]),f=j(e[C]),f.size>0&&(E(p,f.values()),f.clear(),await w())}function Ne(){const e=new Map;return E(e,p.values()),E(e,f.values()),e}function Fe(e){E(p,e);for(const s of e)f.delete(s.site);w()}function De(){if(f.size>0)return[];const e=Array.from(p.values()).filter(s=>s.totalPixels>0).map(A);return e.length===0||(f=new Map(e.map(s=>[s.site,A(s)])),p.clear(),w()),e}function Ke(e){for(const s of e)f.delete(s.site);w()}let B=null;const Be="https://aknzrsgymehrixfwqefq.supabase.co",Ie="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrbnpyc2d5bWVocml4ZndxZWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMjUyODgsImV4cCI6MjA4NjYwMTI4OH0.ESpNDYKwlK72Ebj19yk5qoUDtOr3PY_rQ5dQSelwZL8",Le={getItem:async e=>{const t=(await chrome.storage.local.get(e))[e];if(t==null)return null;if(typeof t=="string")return t;try{return JSON.stringify(t)}catch{return null}},setItem:async(e,s)=>{await chrome.storage.local.set({[e]:s})},removeItem:async e=>{await chrome.storage.local.remove(e)}};async function Oe(e,s,t){var n;const o=`doomscroller:${e}`,r=(n=globalThis.navigator)==null?void 0:n.locks;if(!(r!=null&&r.request))return t();try{return await r.request(o,{mode:"exclusive"},async()=>t())}catch{return t()}}var de,me;const ke=!!((me=(de=globalThis.navigator)==null?void 0:de.locks)!=null&&me.request);function g(){return B||(B=be(Be,Ie,{auth:{storage:Le,persistSession:!0,autoRefreshToken:ke,lock:Oe,detectSessionInUrl:!1}})),B}const N=new Map;function ye(e){const s=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${s}-${t}-${o}`}function Re(e){return ye(new Date(e))}function fe(){return ye(new Date)}function Ce(){const e=new Date;return e.setHours(0,0,0,0),e.toISOString()}function $(e,s){const t=N.get(e);if(!t)return{dayKey:s,todayMeters:0,todayBysite:{},totalMeters:0,updatedAt:0};if(t.dayKey!==s){const o={...t,dayKey:s,todayMeters:0,todayBysite:{}};return N.set(e,o),o}return t}function $e(e,s,t){N.set(e,{dayKey:s,todayMeters:t.todayMeters,todayBysite:{...t.todayBysite},totalMeters:t.totalMeters,updatedAt:Date.now()})}function Ue(e,s){const t=fe(),o=$(e,t),r={...o,todayBysite:{...o.todayBysite}};for(const n of s){const i=Number(n.totalMeters||0);if(!(!Number.isFinite(i)||i<=0)&&(r.totalMeters+=i,Re(n.lastUpdate)===t)){const c=D(n.site);if(!c)continue;r.todayMeters+=i,r.todayBysite[c]=(r.todayBysite[c]??0)+i}}r.updatedAt=Date.now(),N.set(e,r)}const U="doomscroller_feature_flags",b={aiAchievements:!0,chatV2:!0,achievementToast:!0};function pe(e){const s=e&&typeof e=="object"?e:{};return{aiAchievements:typeof s.aiAchievements=="boolean"?s.aiAchievements:b.aiAchievements,chatV2:typeof s.chatV2=="boolean"?s.chatV2:b.chatV2,achievementToast:typeof s.achievementToast=="boolean"?s.achievementToast:b.achievementToast}}let x={...b},ee=!1;function Pe(e,s){if(s!=="local")return;const t=e[U];t&&(x=pe(t.newValue))}async function Ye(){if(ee)return;ee=!0;const e=await chrome.storage.local.get(U);x=pe(e[U]),chrome.storage.onChanged.addListener(Pe)}function ge(){return x}const P="achievementJobsQueue",te=[2e3,1e4,3e4,12e4,3e5],Ve=2e3;let _=[],se=!1,I=!1,oe=0;function y(e,s,t){const o=String(e??"").trim();return o?o.slice(0,s):t}function qe(e){const s=Math.min(Math.max(e-1,0),te.length-1);return te[s]}function ze(e){return e==="legendary"||e==="epic"||e==="rare"?e:"common"}function xe(e){return Array.isArray(e)?e.filter(t=>!!t&&typeof t=="object").map(t=>t).filter(t=>typeof t.userId=="string"&&typeof t.eventKey=="string").map(t=>{var o,r,n,i,c,a,u,m,l,M,S,d,h,v,Q,Z;return{userId:String(t.userId),eventKey:String(t.eventKey),trigger:{type:y(String(((o=t.trigger)==null?void 0:o.type)??"scroll_pattern"),64,"scroll_pattern"),value:Number(((r=t.trigger)==null?void 0:r.value)??0),site:(n=t.trigger)!=null&&n.site?String(t.trigger.site).toLowerCase():null,timestamp:Number(((i=t.trigger)==null?void 0:i.timestamp)??Date.now())},runtimeSnapshot:{dayKey:y(String(((c=t.runtimeSnapshot)==null?void 0:c.dayKey)??""),32,""),todayMeters:Number(((a=t.runtimeSnapshot)==null?void 0:a.todayMeters)??0),todayBySite:(u=t.runtimeSnapshot)!=null&&u.todayBySite&&typeof t.runtimeSnapshot.todayBySite=="object"?Object.fromEntries(Object.entries(t.runtimeSnapshot.todayBySite).filter(([,K])=>Number.isFinite(K)).map(([K,we])=>[K,Number(we)])):{},rolling30Meters:Number(((m=t.runtimeSnapshot)==null?void 0:m.rolling30Meters)??0),sessionMeters:Number(((l=t.runtimeSnapshot)==null?void 0:l.sessionMeters)??0),sessionDurationSec:Number(((M=t.runtimeSnapshot)==null?void 0:M.sessionDurationSec)??0)},toast:{title:y(String(((S=t.toast)==null?void 0:S.title)??"Doom Achievement"),64,"Doom Achievement"),description:y(String(((d=t.toast)==null?void 0:d.description)??""),200,""),icon:y(String(((h=t.toast)==null?void 0:h.icon)??"ðŸ†"),4,"ðŸ†"),rarity:ze((v=t.toast)==null?void 0:v.rarity),roastLine:y(String(((Q=t.toast)==null?void 0:Q.roastLine)??""),220,""),appScope:(Z=t.toast)!=null&&Z.appScope?String(t.toast.appScope):null},meta:t.meta&&typeof t.meta=="object"?t.meta:{},attempt:Number(t.attempt??0),nextAttemptAt:Number(t.nextAttemptAt??Date.now()),createdAt:Number(t.createdAt??Date.now())}}).filter(t=>Number.isFinite(t.nextAttemptAt)&&Number.isFinite(t.createdAt)):[]}async function Se(){if(se)return;const e=await chrome.storage.local.get(P);_=xe(e[P]),se=!0}async function he(){await chrome.storage.local.set({[P]:_})}function We(e){return`${e.userId}::${e.eventKey}`}function Je(e,s){const t=`${e}::${s}`;return _.some(o=>We(o)===t)}function Ge(e){return{user_id:e.userId,trigger_type:y(e.trigger.type,64,"scroll_pattern"),trigger_value:Number.isFinite(e.trigger.value)?Number(e.trigger.value):0,title:y(e.toast.title,64,"Doom Achievement"),description:y(e.toast.description||e.toast.roastLine,180,"You unlocked a doomscroll achievement."),icon:y(e.toast.icon,4,"ðŸ†"),earned_at:new Date().toISOString(),event_key:y(e.eventKey,180,`event_${Date.now()}`),rarity:e.toast.rarity,app_scope:e.toast.appScope??e.trigger.site,meta:{roast_line:e.toast.roastLine,trigger:e.trigger,runtime_snapshot:e.runtimeSnapshot,rule_meta:e.meta},source:"rule"}}async function re(e){const s=g(),t=Ge(e),o=await s.from("achievements").insert(t).select("id").single();if(!o.error)return o.data??null;const r=o.error.message.toLowerCase();if(r.includes("duplicate key")){const n=await s.from("achievements").select("id").eq("user_id",e.userId).eq("event_key",t.event_key).order("earned_at",{ascending:!1}).limit(1).maybeSingle();if(!n.error)return n.data??null}if(r.includes("event_key")||r.includes("rarity")||r.includes("app_scope")||r.includes("meta")){const n=await s.from("achievements").insert({user_id:e.userId,trigger_type:t.trigger_type,trigger_value:t.trigger_value,title:t.title,description:t.description,icon:t.icon,earned_at:t.earned_at}).select("id").single();if(!n.error)return n.data??null}throw o.error}async function He(e){const s=g(),{data:{session:t}}=await s.auth.getSession(),o=(t==null?void 0:t.access_token)??"",r=await s.functions.invoke("generate-achievement",{body:{eventKey:e.eventKey,trigger:e.trigger,runtimeSnapshot:e.runtimeSnapshot,accessToken:o},headers:o?{Authorization:`Bearer ${o}`,"x-ds-token":o}:void 0});if(r.error)throw r.error;const n=r.data;return(n==null?void 0:n.achievement)??null}async function Qe(e){if(!ge().aiAchievements)return re(e);try{return await He(e)}catch(t){const o=t instanceof Error?t.message.toLowerCase():"";if(o.includes("function")||o.includes("404")||o.includes("network")||o.includes("failed to fetch"))return re(e);throw t}}function Ze(e){e.attempt+=1,e.nextAttemptAt=Date.now()+qe(e.attempt)}function Xe(e,s){chrome.runtime.sendMessage({type:"ACHIEVEMENT_SYNCED",payload:{userId:e.userId,eventKey:e.eventKey,achievementId:s}}).catch(()=>{})}async function je(e){await Se(),!Je(e.userId,e.eventKey)&&(_.push({userId:e.userId,eventKey:e.eventKey,trigger:e.trigger,runtimeSnapshot:e.runtimeSnapshot,toast:e.toast,meta:e.meta,attempt:0,nextAttemptAt:Date.now(),createdAt:Date.now()}),await he())}async function W(){var e;if(!I){I=!0;try{if(await Se(),_.length===0)return;const s=g(),{data:{session:t}}=await s.auth.getSession();if(!((e=t==null?void 0:t.user)!=null&&e.id))return;const o=Date.now(),r=t.user.id,n=[];for(const i of _){if(i.userId!==r){n.push(i);continue}if(i.nextAttemptAt>o){n.push(i);continue}try{const c=await Qe(i);Xe(i,c==null?void 0:c.id)}catch{Ze(i),n.push(i)}}_=n,await he()}finally{I=!1}}}function J(){const e=Date.now();e-oe<Ve||(oe=e,W())}const _e="sync-scroll",et=5e3;let T=!1,ne=0;function Me(){chrome.alarms.create(_e,{periodInMinutes:Te})}function tt(e){e.name===_e&&(G(),W())}function st(){const e=Date.now();J(),!T&&(e-ne<et||(ne=e,G()))}function ot(e){const s=e.toLowerCase();return s.includes("foreign key")&&s.includes("scroll_sessions_user_id_fkey")}async function G(){if(T)return;T=!0;const e=g();try{const{data:{session:s}}=await e.auth.getSession();if(!s)return;await X(e,s.user);const t=De();if(t.length===0)return;const o=t.map(n=>({user_id:s.user.id,site:n.site,pixels_scrolled:Math.round(n.totalPixels),meters_scrolled:parseFloat(n.totalMeters.toFixed(4)),duration_seconds:Math.round((n.lastUpdate-n.sessionStart)/1e3),session_start:new Date(n.sessionStart).toISOString(),session_end:new Date(n.lastUpdate).toISOString()}));let{error:r}=await e.from("scroll_sessions").insert(o);r&&ot(r.message)&&(await X(e,s.user),r=(await e.from("scroll_sessions").insert(o)).error),r?(console.error("[DoomScroller] Sync failed:",r.message),Fe(t)):(Ue(s.user.id,t),Ke(t),console.log(`[DoomScroller] Synced ${o.length} session(s) to Supabase`))}finally{T=!1,J()}}function ie(e,s){if(s<=0)return{site:null,share:0};const t=Object.entries(e).sort((o,r)=>r[1]-o[1]);return t.length===0?{site:null,share:0}:{site:t[0][0],share:t[0][1]/s}}function rt(e){const s=[],t=[100,250,500,1e3,2e3];for(const l of t)e.previousTodayMeters<l&&e.todayMeters>=l&&s.push({eventKey:`daily_distance_${l}_${e.dayKey}`,triggerType:"daily_distance_threshold",triggerValue:l,title:`${l}m Regret`,description:`You crossed ${l}m today. Productivity remains theoretical.`,icon:l>=1e3?"ðŸ”¥":"ðŸ†",rarity:l>=1e3?"epic":l>=500?"rare":"common",appScope:null,roastLine:"Your thumb is building endurance faster than your assignments.",meta:{threshold:l,dayKey:e.dayKey}});const o=ie(e.previousTodayBySite,e.previousTodayMeters),r=ie(e.todayBySite,e.todayMeters),n=o.site&&o.share>=.75&&e.previousTodayMeters>=180,i=r.site&&r.share>=.75&&e.todayMeters>=180;!n&&i&&r.site&&s.push({eventKey:`app_specialist_${r.site}_${e.dayKey}`,triggerType:"app_specialist",triggerValue:Number((r.share*100).toFixed(2)),title:`${r.site.toUpperCase()} Loyalist`,description:`${Math.round(r.share*100)}% of today's scroll happened on ${r.site}.`,icon:"ðŸ“±",rarity:"epic",appScope:r.site,roastLine:`You didn't browse apps. You moved into ${r.site}.`,meta:{share:Number(r.share.toFixed(4))}});const c=Object.keys(e.previousTodayBySite).filter(l=>e.previousTodayBySite[l]>0).length,a=Object.keys(e.todayBySite).filter(l=>e.todayBySite[l]>0).length;c<4&&a>=4&&e.todayMeters>=200&&s.push({eventKey:`app_diversity_4_${e.dayKey}`,triggerType:"app_diversity",triggerValue:a,title:"Multi-Feed Tourist",description:`You sampled ${a} apps today. Procrastination buffet unlocked.`,icon:"ðŸŒ€",rarity:"rare",appScope:null,roastLine:"You diversified your distraction portfolio.",meta:{uniqueSites:a}}),e.previousRolling30Meters<40&&e.rolling30Meters>=40&&s.push({eventKey:`burst_scroll_${e.dayKey}`,triggerType:"burst_scroll",triggerValue:Number(e.rolling30Meters.toFixed(2)),title:"Doom Sprint",description:`${Math.round(e.rolling30Meters)}m in 30s. Your thumb is speedrunning.`,icon:"âš¡",rarity:"rare",appScope:e.site,roastLine:"That burst had more urgency than your deadlines.",meta:{windowSeconds:30}});const u=e.previousSessionDurationSec>=20*60&&e.previousSessionMeters>=250,m=e.sessionDurationSec>=20*60&&e.sessionMeters>=250;return!u&&m&&s.push({eventKey:`session_marathon_${e.dayKey}`,triggerType:"session_marathon",triggerValue:Number(e.sessionMeters.toFixed(2)),title:"Infinite Scroll Endurance",description:`You survived a ${Math.round(e.sessionDurationSec/60)} min doom session.`,icon:"ðŸ”¥",rarity:"epic",appScope:r.site??e.site,roastLine:"Your stamina is impressive and deeply concerning.",meta:{sessionDurationSec:Math.round(e.sessionDurationSec)}}),s}const nt="achievementRuntimeState:",it=5*60*1e3,at=30*1e3,Y=400,ct=1200,F=new Map,L=new Map,ae=new Set,O=new Map;function V(e){return`${nt}${e}`}function H(e){const s=new Date(e),t=s.getFullYear(),o=String(s.getMonth()+1).padStart(2,"0"),r=String(s.getDate()).padStart(2,"0");return`${t}-${o}-${r}`}function q(e){return{dayKey:H(e),todayMeters:0,todayBySite:{},rollingWindow:[],sessionStartTs:e,sessionMeters:0,lastScrollTs:e,unlockedEventKeys:[]}}function lt(e,s){if(!e||typeof e!="object")return q(s);const t=e,o=q(s);return typeof t.dayKey=="string"&&(o.dayKey=t.dayKey),Number.isFinite(t.todayMeters)&&(o.todayMeters=Number(t.todayMeters)),t.todayBySite&&typeof t.todayBySite=="object"&&(o.todayBySite=Object.fromEntries(Object.entries(t.todayBySite).filter(([,r])=>Number.isFinite(r)).map(([r,n])=>[r,Number(n)]))),Array.isArray(t.rollingWindow)&&(o.rollingWindow=t.rollingWindow.filter(r=>!!r&&typeof r=="object").map(r=>({timestamp:Number(r.timestamp??0),meters:Number(r.meters??0),site:String(r.site??"unknown").toLowerCase()})).filter(r=>Number.isFinite(r.timestamp)&&Number.isFinite(r.meters)&&r.meters>0)),Number.isFinite(t.sessionStartTs)&&(o.sessionStartTs=Number(t.sessionStartTs)),Number.isFinite(t.sessionMeters)&&(o.sessionMeters=Number(t.sessionMeters)),Number.isFinite(t.lastScrollTs)&&(o.lastScrollTs=Number(t.lastScrollTs)),Array.isArray(t.unlockedEventKeys)&&(o.unlockedEventKeys=t.unlockedEventKeys.map(r=>String(r)).filter(r=>r.length>0).slice(-Y)),o}function ut(e,s){const t=F.get(e);if(t)return t;const o=q(s);return F.set(e,o),o}function dt(e){if(O.has(e))return;const s=setTimeout(()=>{O.delete(e);const t=F.get(e);t&&chrome.storage.local.set({[V(e)]:t})},ct);O.set(e,s)}async function mt(e,s){if(ae.has(e))return;const t=L.get(e);if(t){await t;return}const o=(async()=>{const r=await chrome.storage.local.get(V(e)),n=lt(r[V(e)],s),i=H(s);n.dayKey!==i&&(n.dayKey=i,n.todayMeters=0,n.todayBySite={},n.rollingWindow=[],n.sessionStartTs=s,n.sessionMeters=0),F.set(e,n),ae.add(e)})().finally(()=>{L.delete(e)});L.set(e,o),await o}function ce(e,s){const t=s-at;e.rollingWindow=e.rollingWindow.filter(o=>o.timestamp>=t)}function z(e){return e.rollingWindow.reduce((s,t)=>s+t.meters,0)}function yt(e,s){const t=Math.max(0,(s-e.sessionStartTs)/1e3);return{dayKey:e.dayKey,todayMeters:Number(e.todayMeters.toFixed(2)),todayBySite:{...e.todayBySite},rolling30Meters:Number(z(e).toFixed(2)),sessionMeters:Number(e.sessionMeters.toFixed(2)),sessionDurationSec:Number(t.toFixed(2))}}function ft(e){return{eventKey:e.eventKey,title:e.title,description:e.description,icon:e.icon,rarity:e.rarity,roastLine:e.roastLine,appScope:e.appScope}}function pt(e,s){return e.unlockedEventKeys.includes(s)?!1:(e.unlockedEventKeys.push(s),e.unlockedEventKeys.length>Y&&(e.unlockedEventKeys=e.unlockedEventKeys.slice(-Y)),!0)}async function gt(e,s){if(!s.aiAchievements&&!s.achievementToast)return[];const t=Number(e.meters);if(!Number.isFinite(t)||t<=0)return[];await mt(e.userId,e.timestamp);const o=ut(e.userId,e.timestamp),r=H(e.timestamp);o.dayKey!==r&&(o.dayKey=r,o.todayMeters=0,o.todayBySite={},o.rollingWindow=[],o.sessionStartTs=e.timestamp,o.sessionMeters=0),e.timestamp-o.lastScrollTs>it&&(o.sessionStartTs=e.timestamp,o.sessionMeters=0,o.rollingWindow=[]),ce(o,e.timestamp);const n=z(o),i=o.todayMeters,c={...o.todayBySite},a=o.sessionMeters,u=Math.max(0,(e.timestamp-o.sessionStartTs)/1e3);o.todayMeters+=t,o.todayBySite[e.site]=(o.todayBySite[e.site]??0)+t,o.sessionMeters+=t,o.lastScrollTs=e.timestamp,o.rollingWindow.push({timestamp:e.timestamp,meters:t,site:e.site}),ce(o,e.timestamp);const m=z(o),l=Math.max(0,(e.timestamp-o.sessionStartTs)/1e3),M=rt({dayKey:o.dayKey,site:e.site,timestamp:e.timestamp,todayMeters:o.todayMeters,todayBySite:o.todayBySite,rolling30Meters:m,sessionMeters:o.sessionMeters,sessionDurationSec:l,previousTodayMeters:i,previousTodayBySite:c,previousRolling30Meters:n,previousSessionMeters:a,previousSessionDurationSec:u}),S=[];for(const d of M)pt(o,d.eventKey)&&S.push({userId:e.userId,eventKey:d.eventKey,trigger:{type:d.triggerType,value:d.triggerValue,site:d.appScope,timestamp:e.timestamp},toast:ft(d),runtimeSnapshot:yt(o,e.timestamp),meta:d.meta});return dt(e.userId),S}const St=5e3,ht=250,_t=1500,k=new Map,le=new Map;function Mt(e){return new Promise(s=>setTimeout(s,e))}async function ve(){var t;const e=g(),{data:{session:s}}=await e.auth.getSession();return((t=s==null?void 0:s.user)==null?void 0:t.id)??null}async function vt(e){const s=g(),{data:t,error:o}=await s.from("battle_room_members").select("room_id, joined_at").eq("user_id",e).eq("status","joined").order("joined_at",{ascending:!1}).limit(12);if(o)return{active:!1};const r=(t??[]).map(u=>u.room_id).filter(u=>!!u);if(r.length===0)return{active:!1};const{data:n,error:i}=await s.from("battle_rooms").select("id, room_key, status, selected_game_type, round_started_at, round_ends_at, timer_seconds").in("id",r).order("round_ends_at",{ascending:!1,nullsFirst:!1});if(i||!n||n.length===0)return{active:!1};const c=Date.now(),a=n.find(u=>{if(u.status!=="active"||!u.round_started_at||!u.round_ends_at)return!1;const m=Date.parse(u.round_ends_at);return Number.isFinite(m)&&m>c});return a?{active:!0,roomId:a.id,roomKey:a.room_key,gameType:a.selected_game_type??null,roundStartedAt:a.round_started_at,roundEndsAt:a.round_ends_at,timerSeconds:Number(a.timer_seconds??0)}:{active:!1}}async function wt(e){const s=le.get(e),t=Date.now();if(s&&t-s.updatedAt<_t)return s.value;const o=await vt(e);return le.set(e,{updatedAt:t,value:o}),o}function bt(e){const s={};let t=0;for(const o of e){const r=D(o.site);if(!r)continue;const n=Number(o.meters_scrolled??0);Number.isFinite(n)&&(t+=n,s[r]=(s[r]??0)+n)}return{todayMeters:t,todayBysite:s}}function ue(e,s,t){const o=k.get(e);if(o)return o;const r=(async()=>{const n=g(),[{data:i},{data:c}]=await Promise.all([n.from("scroll_sessions").select("site, meters_scrolled").eq("user_id",e).gte("created_at",t),n.from("profiles").select("total_meters_scrolled").eq("id",e).single()]),a=bt(i??[]),u=Number((c==null?void 0:c.total_meters_scrolled)??0);$e(e,s,{todayMeters:parseFloat(a.todayMeters.toFixed(2)),todayBysite:a.todayBysite,totalMeters:parseFloat(u.toFixed(2))})})().finally(()=>{k.delete(e)});return k.set(e,r),r}async function Tt(e,s,t,o){const r=await ve();if(!r)return;const n=ge(),i=await gt({userId:r,site:e,meters:s,timestamp:t},n);if(i.length!==0){for(const c of i)n.achievementToast&&typeof o=="number"&&chrome.tabs.sendMessage(o,{type:"ACHIEVEMENT_TOAST",payload:c.toast}).catch(()=>{}),await je(c);J()}}function At(e,s,t){var o;switch(e.type){case"SCROLL_UPDATE":{const{site:r,pixels:n,meters:i,timestamp:c}=e.payload,a=D(r);return!a||!Number.isFinite(n)||!Number.isFinite(i)||n<=0||i<=0?(t({ok:!1}),!1):(Ae(a,n,i),st(),Tt(a,i,c,(o=s.tab)==null?void 0:o.id),t({ok:!0}),!1)}case"GET_STATS":return Et().then(t).catch(()=>{t({todayMeters:0,todayBysite:{},totalMeters:0})}),!0;case"GET_BATTLE_TIMER":return ve().then(r=>r?wt(r):{active:!1}).then(t).catch(()=>{t({active:!1})}),!0;default:return!1}}async function Et(){const e=Ne();let s=0;const t={};for(const[d,h]of e){const v=D(d);v&&(s+=h.totalMeters,t[v]=(t[v]??0)+h.totalMeters)}const o=g(),{data:{session:r}}=await o.auth.getSession();if(!r)return{todayMeters:parseFloat(s.toFixed(2)),todayBysite:t,totalMeters:parseFloat(s.toFixed(2))};const n=r.user.id,i=fe(),c=Ce();let a=$(n,i);const u=a.updatedAt===0,m=Date.now()-a.updatedAt>St;u?await Promise.race([ue(n,i,c),Mt(ht)]):m&&ue(n,i,c),a=$(n,i);const l={...a.todayBysite};for(const[d,h]of Object.entries(t))l[d]=(l[d]??0)+h;const M=a.todayMeters+s,S=a.totalMeters+s;return{todayMeters:parseFloat(M.toFixed(2)),todayBysite:l,totalMeters:parseFloat(S.toFixed(2))}}console.log("[DoomScroller] Background service worker loaded");Ee();Ye();chrome.runtime.onInstalled.addListener(()=>{console.log("[DoomScroller] Extension installed"),Me()});Me();G();W();chrome.runtime.onMessage.addListener(At);chrome.alarms.onAlarm.addListener(tt);
