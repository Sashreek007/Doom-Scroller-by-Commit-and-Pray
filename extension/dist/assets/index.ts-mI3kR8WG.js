import{c as be,e as Z}from"./profile-DccX_sEz.js";import{t as D,a as Ae}from"./constants-BqRKAH88.js";const R="scrollBatches",C="scrollBatchesInFlight";let S=new Map,g=new Map;function T(e){return{...e}}function N(e,s){for(const t of s){const r=e.get(t.site);r?(r.totalPixels+=t.totalPixels,r.totalMeters+=t.totalMeters,r.sessionStart=Math.min(r.sessionStart,t.sessionStart),r.lastUpdate=Math.max(r.lastUpdate,t.lastUpdate)):e.set(t.site,T(t))}}function X(e){if(!e||typeof e!="object")return new Map;const s=Object.entries(e);return new Map(s.map(([t,r])=>[t,T(r)]))}function Te(e,s,t){const r=S.get(e);r?(r.totalPixels+=s,r.totalMeters+=t,r.lastUpdate=Date.now()):S.set(e,{site:e,totalPixels:s,totalMeters:t,sessionStart:Date.now(),lastUpdate:Date.now()}),w()}async function w(){await chrome.storage.local.set({[R]:Object.fromEntries(S),[C]:Object.fromEntries(g)})}async function Ne(){const e=await chrome.storage.local.get([R,C]);S=X(e[R]),g=X(e[C]),g.size>0&&(N(S,g.values()),g.clear(),await w())}function Fe(){const e=new Map;return N(e,S.values()),N(e,g.values()),e}function Ee(e){N(S,e);for(const s of e)g.delete(s.site);w()}function De(){if(g.size>0)return[];const e=Array.from(S.values()).filter(s=>s.totalPixels>0).map(T);return e.length===0||(g=new Map(e.map(s=>[s.site,T(s)])),S.clear(),w()),e}function Ke(e){for(const s of e)g.delete(s.site);w()}let B=null;const Be="https://aknzrsgymehrixfwqefq.supabase.co",Ie="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrbnpyc2d5bWVocml4ZndxZWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMjUyODgsImV4cCI6MjA4NjYwMTI4OH0.ESpNDYKwlK72Ebj19yk5qoUDtOr3PY_rQ5dQSelwZL8",ke={getItem:async e=>{const t=(await chrome.storage.local.get(e))[e];if(t==null)return null;if(typeof t=="string")return t;try{return JSON.stringify(t)}catch{return null}},setItem:async(e,s)=>{await chrome.storage.local.set({[e]:s})},removeItem:async e=>{await chrome.storage.local.remove(e)}};async function Le(e,s,t){var n;const r=`doomscroller:${e}`,o=(n=globalThis.navigator)==null?void 0:n.locks;if(!(o!=null&&o.request))return t();try{return await o.request(r,{mode:"exclusive"},async()=>t())}catch{return t()}}var de,me;const Oe=!!((me=(de=globalThis.navigator)==null?void 0:de.locks)!=null&&me.request);function h(){return B||(B=be(Be,Ie,{auth:{storage:ke,persistSession:!0,autoRefreshToken:Oe,lock:Le,detectSessionInUrl:!1}})),B}const F=new Map;function ye(e){const s=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${s}-${t}-${r}`}function Re(e){return ye(new Date(e))}function fe(){return ye(new Date)}function Ce(){const e=new Date;return e.setHours(0,0,0,0),e.toISOString()}function U(e,s){const t=F.get(e);if(!t)return{dayKey:s,todayMeters:0,todayBysite:{},totalMeters:0,updatedAt:0};if(t.dayKey!==s){const r={...t,dayKey:s,todayMeters:0,todayBysite:{}};return F.set(e,r),r}return t}function Ue(e,s,t){F.set(e,{dayKey:s,todayMeters:t.todayMeters,todayBysite:{...t.todayBysite},totalMeters:t.totalMeters,updatedAt:Date.now()})}function $e(e,s){const t=fe(),r=U(e,t),o={...r,todayBysite:{...r.todayBysite}};for(const n of s){const i=Number(n.totalMeters||0);if(!(!Number.isFinite(i)||i<=0)&&(o.totalMeters+=i,Re(n.lastUpdate)===t)){const a=D(n.site);if(!a)continue;o.todayMeters+=i,o.todayBysite[a]=(o.todayBysite[a]??0)+i}}o.updatedAt=Date.now(),F.set(e,o)}const $="doomscroller_feature_flags",b={aiAchievements:!0,chatV2:!0,achievementToast:!0};function pe(e){const s=e&&typeof e=="object"?e:{};return{aiAchievements:typeof s.aiAchievements=="boolean"?s.aiAchievements:b.aiAchievements,chatV2:typeof s.chatV2=="boolean"?s.chatV2:b.chatV2,achievementToast:typeof s.achievementToast=="boolean"?s.achievementToast:b.achievementToast}}let x={...b},ee=!1;function Pe(e,s){if(s!=="local")return;const t=e[$];t&&(x=pe(t.newValue))}async function Ye(){if(ee)return;ee=!0;const e=await chrome.storage.local.get($);x=pe(e[$]),chrome.storage.onChanged.addListener(Pe)}function ge(){return x}const P="achievementJobsQueue",te=[2e3,1e4,3e4,12e4,3e5],ze=2e3;let M=[],se=!1,I=!1,re=0;function p(e,s,t){const r=String(e??"").trim();return r?r.slice(0,s):t}function Ve(e){const s=Math.min(Math.max(e-1,0),te.length-1);return te[s]}function qe(e){return e==="legendary"||e==="epic"||e==="rare"?e:"common"}function xe(e){return Array.isArray(e)?e.filter(t=>!!t&&typeof t=="object").map(t=>t).filter(t=>typeof t.userId=="string"&&typeof t.eventKey=="string").map(t=>{var r,o,n,i,a,c,m,f,l,y,u,d,_,v,Q,j;return{userId:String(t.userId),eventKey:String(t.eventKey),trigger:{type:p(String(((r=t.trigger)==null?void 0:r.type)??"scroll_pattern"),64,"scroll_pattern"),value:Number(((o=t.trigger)==null?void 0:o.value)??0),site:(n=t.trigger)!=null&&n.site?String(t.trigger.site).toLowerCase():null,timestamp:Number(((i=t.trigger)==null?void 0:i.timestamp)??Date.now())},runtimeSnapshot:{dayKey:p(String(((a=t.runtimeSnapshot)==null?void 0:a.dayKey)??""),32,""),todayMeters:Number(((c=t.runtimeSnapshot)==null?void 0:c.todayMeters)??0),todayBySite:(m=t.runtimeSnapshot)!=null&&m.todayBySite&&typeof t.runtimeSnapshot.todayBySite=="object"?Object.fromEntries(Object.entries(t.runtimeSnapshot.todayBySite).filter(([,K])=>Number.isFinite(K)).map(([K,we])=>[K,Number(we)])):{},rolling30Meters:Number(((f=t.runtimeSnapshot)==null?void 0:f.rolling30Meters)??0),sessionMeters:Number(((l=t.runtimeSnapshot)==null?void 0:l.sessionMeters)??0),sessionDurationSec:Number(((y=t.runtimeSnapshot)==null?void 0:y.sessionDurationSec)??0)},toast:{title:p(String(((u=t.toast)==null?void 0:u.title)??"Doom Achievement"),64,"Doom Achievement"),description:p(String(((d=t.toast)==null?void 0:d.description)??""),200,""),icon:p(String(((_=t.toast)==null?void 0:_.icon)??"ðŸ†"),4,"ðŸ†"),rarity:qe((v=t.toast)==null?void 0:v.rarity),roastLine:p(String(((Q=t.toast)==null?void 0:Q.roastLine)??""),220,""),appScope:(j=t.toast)!=null&&j.appScope?String(t.toast.appScope):null},meta:t.meta&&typeof t.meta=="object"?t.meta:{},attempt:Number(t.attempt??0),nextAttemptAt:Number(t.nextAttemptAt??Date.now()),createdAt:Number(t.createdAt??Date.now())}}).filter(t=>Number.isFinite(t.nextAttemptAt)&&Number.isFinite(t.createdAt)):[]}async function Se(){if(se)return;const e=await chrome.storage.local.get(P);M=xe(e[P]),se=!0}async function he(){await chrome.storage.local.set({[P]:M})}function We(e){return`${e.userId}::${e.eventKey}`}function Je(e,s){const t=`${e}::${s}`;return M.some(r=>We(r)===t)}function Ge(e){return{user_id:e.userId,trigger_type:p(e.trigger.type,64,"scroll_pattern"),trigger_value:Number.isFinite(e.trigger.value)?Number(e.trigger.value):0,title:p(e.toast.title,64,"Doom Achievement"),description:p(e.toast.description||e.toast.roastLine,180,"You unlocked a doomscroll achievement."),icon:p(e.toast.icon,4,"ðŸ†"),earned_at:new Date().toISOString(),event_key:p(e.eventKey,180,`event_${Date.now()}`),rarity:e.toast.rarity,app_scope:e.toast.appScope??e.trigger.site,meta:{roast_line:e.toast.roastLine,trigger:e.trigger,runtime_snapshot:e.runtimeSnapshot,rule_meta:e.meta},source:"rule"}}async function oe(e){const s=h(),t=Ge(e),r=await s.from("achievements").insert(t).select("id").single();if(!r.error)return r.data??null;const o=r.error.message.toLowerCase();if(o.includes("duplicate key")){const n=await s.from("achievements").select("id").eq("user_id",e.userId).eq("event_key",t.event_key).order("earned_at",{ascending:!1}).limit(1).maybeSingle();if(!n.error)return n.data??null}if(o.includes("event_key")||o.includes("rarity")||o.includes("app_scope")||o.includes("meta")){const n=await s.from("achievements").insert({user_id:e.userId,trigger_type:t.trigger_type,trigger_value:t.trigger_value,title:t.title,description:t.description,icon:t.icon,earned_at:t.earned_at}).select("id").single();if(!n.error)return n.data??null}throw r.error}async function He(e){const s=h(),{data:{session:t}}=await s.auth.getSession(),r=(t==null?void 0:t.access_token)??"",o=await s.functions.invoke("generate-achievement",{body:{eventKey:e.eventKey,trigger:e.trigger,runtimeSnapshot:e.runtimeSnapshot,accessToken:r},headers:r?{Authorization:`Bearer ${r}`,"x-ds-token":r}:void 0});if(o.error)throw o.error;const n=o.data;return(n==null?void 0:n.achievement)??null}async function Qe(e){if(!ge().aiAchievements)return oe(e);try{return await He(e)}catch(t){const r=t instanceof Error?t.message.toLowerCase():"";if(r.includes("function")||r.includes("404")||r.includes("network")||r.includes("failed to fetch"))return oe(e);throw t}}function je(e){e.attempt+=1,e.nextAttemptAt=Date.now()+Ve(e.attempt)}function Ze(e,s){chrome.runtime.sendMessage({type:"ACHIEVEMENT_SYNCED",payload:{userId:e.userId,eventKey:e.eventKey,achievementId:s}}).catch(()=>{})}async function Xe(e){await Se(),!Je(e.userId,e.eventKey)&&(M.push({userId:e.userId,eventKey:e.eventKey,trigger:e.trigger,runtimeSnapshot:e.runtimeSnapshot,toast:e.toast,meta:e.meta,attempt:0,nextAttemptAt:Date.now(),createdAt:Date.now()}),await he())}async function W(){var e;if(!I){I=!0;try{if(await Se(),M.length===0)return;const s=h(),{data:{session:t}}=await s.auth.getSession();if(!((e=t==null?void 0:t.user)!=null&&e.id))return;const r=Date.now(),o=t.user.id,n=[];for(const i of M){if(i.userId!==o){n.push(i);continue}if(i.nextAttemptAt>r){n.push(i);continue}try{const a=await Qe(i);Ze(i,a==null?void 0:a.id)}catch{je(i),n.push(i)}}M=n,await he()}finally{I=!1}}}function J(){const e=Date.now();e-re<ze||(re=e,W())}const _e="sync-scroll",et=5e3;let A=!1,ne=0;function Me(){chrome.alarms.create(_e,{periodInMinutes:Ae})}function tt(e){e.name===_e&&(G(),W())}function st(){const e=Date.now();J(),!A&&(e-ne<et||(ne=e,G()))}function rt(e){const s=e.toLowerCase();return s.includes("foreign key")&&s.includes("scroll_sessions_user_id_fkey")}async function G(){if(A)return;A=!0;const e=h();try{const{data:{session:s}}=await e.auth.getSession();if(!s)return;await Z(e,s.user);const t=De();if(t.length===0)return;const r=t.map(n=>({user_id:s.user.id,site:n.site,pixels_scrolled:Math.round(n.totalPixels),meters_scrolled:parseFloat(n.totalMeters.toFixed(4)),duration_seconds:Math.round((n.lastUpdate-n.sessionStart)/1e3),session_start:new Date(n.sessionStart).toISOString(),session_end:new Date(n.lastUpdate).toISOString()}));let{error:o}=await e.from("scroll_sessions").insert(r);o&&rt(o.message)&&(await Z(e,s.user),o=(await e.from("scroll_sessions").insert(r)).error),o?(console.error("[DoomScroller] Sync failed:",o.message),Ee(t)):($e(s.user.id,t),Ke(t),console.log(`[DoomScroller] Synced ${r.length} session(s) to Supabase`))}finally{A=!1,J()}}function ie(e,s){if(s<=0)return{site:null,share:0};const t=Object.entries(e).sort((r,o)=>o[1]-r[1]);return t.length===0?{site:null,share:0}:{site:t[0][0],share:t[0][1]/s}}function ot(e){const s=[],t=[100,250,500,1e3,2e3];for(const l of t)e.previousTodayMeters<l&&e.todayMeters>=l&&s.push({eventKey:`daily_distance_${l}_${e.dayKey}`,triggerType:"daily_distance_threshold",triggerValue:l,title:`${l}m Regret`,description:`You crossed ${l}m today. Productivity remains theoretical.`,icon:l>=1e3?"ðŸ”¥":"ðŸ†",rarity:l>=1e3?"epic":l>=500?"rare":"common",appScope:null,roastLine:"Your thumb is building endurance faster than your assignments.",meta:{threshold:l,dayKey:e.dayKey}});const r=ie(e.previousTodayBySite,e.previousTodayMeters),o=ie(e.todayBySite,e.todayMeters),n=r.site&&r.share>=.75&&e.previousTodayMeters>=180,i=o.site&&o.share>=.75&&e.todayMeters>=180;!n&&i&&o.site&&s.push({eventKey:`app_specialist_${o.site}_${e.dayKey}`,triggerType:"app_specialist",triggerValue:Number((o.share*100).toFixed(2)),title:`${o.site.toUpperCase()} Loyalist`,description:`${Math.round(o.share*100)}% of today's scroll happened on ${o.site}.`,icon:"ðŸ“±",rarity:"epic",appScope:o.site,roastLine:`You didn't browse apps. You moved into ${o.site}.`,meta:{share:Number(o.share.toFixed(4))}});const a=Object.keys(e.previousTodayBySite).filter(l=>e.previousTodayBySite[l]>0).length,c=Object.keys(e.todayBySite).filter(l=>e.todayBySite[l]>0).length;a<4&&c>=4&&e.todayMeters>=200&&s.push({eventKey:`app_diversity_4_${e.dayKey}`,triggerType:"app_diversity",triggerValue:c,title:"Multi-Feed Tourist",description:`You sampled ${c} apps today. Procrastination buffet unlocked.`,icon:"ðŸŒ€",rarity:"rare",appScope:null,roastLine:"You diversified your distraction portfolio.",meta:{uniqueSites:c}}),e.previousRolling30Meters<40&&e.rolling30Meters>=40&&s.push({eventKey:`burst_scroll_${e.dayKey}`,triggerType:"burst_scroll",triggerValue:Number(e.rolling30Meters.toFixed(2)),title:"Doom Sprint",description:`${Math.round(e.rolling30Meters)}m in 30s. Your thumb is speedrunning.`,icon:"âš¡",rarity:"rare",appScope:e.site,roastLine:"That burst had more urgency than your deadlines.",meta:{windowSeconds:30}});const m=e.previousSessionDurationSec>=20*60&&e.previousSessionMeters>=250,f=e.sessionDurationSec>=20*60&&e.sessionMeters>=250;return!m&&f&&s.push({eventKey:`session_marathon_${e.dayKey}`,triggerType:"session_marathon",triggerValue:Number(e.sessionMeters.toFixed(2)),title:"Infinite Scroll Endurance",description:`You survived a ${Math.round(e.sessionDurationSec/60)} min doom session.`,icon:"ðŸ”¥",rarity:"epic",appScope:o.site??e.site,roastLine:"Your stamina is impressive and deeply concerning.",meta:{sessionDurationSec:Math.round(e.sessionDurationSec)}}),s}const nt="achievementRuntimeState:",it=5*60*1e3,at=30*1e3,Y=400,ct=1200,E=new Map,k=new Map,ae=new Set,L=new Map;function z(e){return`${nt}${e}`}function H(e){const s=new Date(e),t=s.getFullYear(),r=String(s.getMonth()+1).padStart(2,"0"),o=String(s.getDate()).padStart(2,"0");return`${t}-${r}-${o}`}function V(e){return{dayKey:H(e),todayMeters:0,todayBySite:{},rollingWindow:[],sessionStartTs:e,sessionMeters:0,lastScrollTs:e,unlockedEventKeys:[]}}function lt(e,s){if(!e||typeof e!="object")return V(s);const t=e,r=V(s);return typeof t.dayKey=="string"&&(r.dayKey=t.dayKey),Number.isFinite(t.todayMeters)&&(r.todayMeters=Number(t.todayMeters)),t.todayBySite&&typeof t.todayBySite=="object"&&(r.todayBySite=Object.fromEntries(Object.entries(t.todayBySite).filter(([,o])=>Number.isFinite(o)).map(([o,n])=>[o,Number(n)]))),Array.isArray(t.rollingWindow)&&(r.rollingWindow=t.rollingWindow.filter(o=>!!o&&typeof o=="object").map(o=>({timestamp:Number(o.timestamp??0),meters:Number(o.meters??0),site:String(o.site??"unknown").toLowerCase()})).filter(o=>Number.isFinite(o.timestamp)&&Number.isFinite(o.meters)&&o.meters>0)),Number.isFinite(t.sessionStartTs)&&(r.sessionStartTs=Number(t.sessionStartTs)),Number.isFinite(t.sessionMeters)&&(r.sessionMeters=Number(t.sessionMeters)),Number.isFinite(t.lastScrollTs)&&(r.lastScrollTs=Number(t.lastScrollTs)),Array.isArray(t.unlockedEventKeys)&&(r.unlockedEventKeys=t.unlockedEventKeys.map(o=>String(o)).filter(o=>o.length>0).slice(-Y)),r}function ut(e,s){const t=E.get(e);if(t)return t;const r=V(s);return E.set(e,r),r}function dt(e){if(L.has(e))return;const s=setTimeout(()=>{L.delete(e);const t=E.get(e);t&&chrome.storage.local.set({[z(e)]:t})},ct);L.set(e,s)}async function mt(e,s){if(ae.has(e))return;const t=k.get(e);if(t){await t;return}const r=(async()=>{const o=await chrome.storage.local.get(z(e)),n=lt(o[z(e)],s),i=H(s);n.dayKey!==i&&(n.dayKey=i,n.todayMeters=0,n.todayBySite={},n.rollingWindow=[],n.sessionStartTs=s,n.sessionMeters=0),E.set(e,n),ae.add(e)})().finally(()=>{k.delete(e)});k.set(e,r),await r}function ce(e,s){const t=s-at;e.rollingWindow=e.rollingWindow.filter(r=>r.timestamp>=t)}function q(e){return e.rollingWindow.reduce((s,t)=>s+t.meters,0)}function yt(e,s){const t=Math.max(0,(s-e.sessionStartTs)/1e3);return{dayKey:e.dayKey,todayMeters:Number(e.todayMeters.toFixed(2)),todayBySite:{...e.todayBySite},rolling30Meters:Number(q(e).toFixed(2)),sessionMeters:Number(e.sessionMeters.toFixed(2)),sessionDurationSec:Number(t.toFixed(2))}}function ft(e){return{eventKey:e.eventKey,title:e.title,description:e.description,icon:e.icon,rarity:e.rarity,roastLine:e.roastLine,appScope:e.appScope}}function pt(e,s){return e.unlockedEventKeys.includes(s)?!1:(e.unlockedEventKeys.push(s),e.unlockedEventKeys.length>Y&&(e.unlockedEventKeys=e.unlockedEventKeys.slice(-Y)),!0)}async function gt(e,s){if(!s.aiAchievements&&!s.achievementToast)return[];const t=Number(e.meters);if(!Number.isFinite(t)||t<=0)return[];await mt(e.userId,e.timestamp);const r=ut(e.userId,e.timestamp),o=H(e.timestamp);r.dayKey!==o&&(r.dayKey=o,r.todayMeters=0,r.todayBySite={},r.rollingWindow=[],r.sessionStartTs=e.timestamp,r.sessionMeters=0),e.timestamp-r.lastScrollTs>it&&(r.sessionStartTs=e.timestamp,r.sessionMeters=0,r.rollingWindow=[]),ce(r,e.timestamp);const n=q(r),i=r.todayMeters,a={...r.todayBySite},c=r.sessionMeters,m=Math.max(0,(e.timestamp-r.sessionStartTs)/1e3);r.todayMeters+=t,r.todayBySite[e.site]=(r.todayBySite[e.site]??0)+t,r.sessionMeters+=t,r.lastScrollTs=e.timestamp,r.rollingWindow.push({timestamp:e.timestamp,meters:t,site:e.site}),ce(r,e.timestamp);const f=q(r),l=Math.max(0,(e.timestamp-r.sessionStartTs)/1e3),y=ot({dayKey:r.dayKey,site:e.site,timestamp:e.timestamp,todayMeters:r.todayMeters,todayBySite:r.todayBySite,rolling30Meters:f,sessionMeters:r.sessionMeters,sessionDurationSec:l,previousTodayMeters:i,previousTodayBySite:a,previousRolling30Meters:n,previousSessionMeters:c,previousSessionDurationSec:m}),u=[];for(const d of y)pt(r,d.eventKey)&&u.push({userId:e.userId,eventKey:d.eventKey,trigger:{type:d.triggerType,value:d.triggerValue,site:d.appScope,timestamp:e.timestamp},toast:ft(d),runtimeSnapshot:yt(r,e.timestamp),meta:d.meta});return dt(e.userId),u}const St=5e3,ht=250,_t=400,O=new Map,le=new Map;function Mt(e){return new Promise(s=>setTimeout(s,e))}async function ve(){var t;const e=h(),{data:{session:s}}=await e.auth.getSession();return((t=s==null?void 0:s.user)==null?void 0:t.id)??null}async function vt(e){const s=h(),{error:t}=await s.rpc("finalize_battle_round",{p_room_id:e});if(!t)return;const r=(t.message??"").toLowerCase();r.includes("round is not active")||r.includes("round timer has not completed")||r.includes("room not found")}function wt(e){if(!e.round_result||typeof e.round_result!="object")return null;const s=e.round_result,t=typeof s.settledAt=="string"?s.settledAt:null,r=Number(s.pot),o=Number(s.betCoins);if(!t||!Number.isFinite(r)||!Number.isFinite(o))return null;const n=Array.isArray(s.winnerIds)?s.winnerIds.filter(a=>typeof a=="string"):[],i={};if(s.payouts&&typeof s.payouts=="object")for(const[a,c]of Object.entries(s.payouts)){const m=Number(c);Number.isFinite(m)&&(i[a]=m)}return{roomId:typeof e.id=="string"?e.id:"",roomKey:typeof e.room_key=="string"?e.room_key:"",gameType:typeof e.selected_game_type=="string"?e.selected_game_type:null,settledAt:t,winnerIds:n,payouts:i,pot:Math.max(0,Math.floor(r)),betCoins:Math.max(0,Math.floor(o))}}async function bt(e){const s=h(),{data:t,error:r}=await s.from("battle_room_members").select("room_id, joined_at").eq("user_id",e).eq("status","joined").order("joined_at",{ascending:!1}).limit(12);if(r)return{active:!1,viewerUserId:e};const o=(t??[]).map(u=>u.room_id).filter(u=>!!u);if(o.length===0)return{active:!1,viewerUserId:e};const n="id, room_key, host_id, status, selected_game_type, round_started_at, round_ends_at, timer_seconds, round_result, updated_at",{data:i,error:a}=await s.from("battle_rooms").select(n).in("id",o).order("updated_at",{ascending:!1});if(a||!i||i.length===0)return{active:!1,viewerUserId:e};let c=i;const m=Date.now(),f=c.find(u=>{if(u.status!=="active"||!u.round_ends_at)return!1;const d=Date.parse(u.round_ends_at);return Number.isFinite(d)&&d<=m});if(f!=null&&f.id){await vt(f.id);const{data:u}=await s.from("battle_rooms").select(n).in("id",o).order("updated_at",{ascending:!1});u!=null&&u.length&&(c=u)}let l=null;for(const u of c){const d=wt(u);if(d){l=d;break}}const y=c.find(u=>{if(u.status!=="active"||!u.round_started_at||!u.round_ends_at)return!1;const d=Date.parse(u.round_ends_at);return Number.isFinite(d)&&d>m});return y?{active:!0,viewerUserId:e,roomId:y.id,roomKey:y.room_key,gameType:y.selected_game_type??null,roundStartedAt:y.round_started_at,roundEndsAt:y.round_ends_at,timerSeconds:Number(y.timer_seconds??0),latestRoundResult:l}:{active:!1,viewerUserId:e,latestRoundResult:l}}async function At(e){const s=le.get(e),t=Date.now();if(s&&t-s.updatedAt<_t)if(s.value.active){const o=Date.parse(s.value.roundEndsAt??"");if(!(Number.isFinite(o)&&o<=t))return s.value}else return s.value;const r=await bt(e);return le.set(e,{updatedAt:t,value:r}),r}function Tt(e){const s={};let t=0;for(const r of e){const o=D(r.site);if(!o)continue;const n=Number(r.meters_scrolled??0);Number.isFinite(n)&&(t+=n,s[o]=(s[o]??0)+n)}return{todayMeters:t,todayBysite:s}}function ue(e,s,t){const r=O.get(e);if(r)return r;const o=(async()=>{const n=h(),[{data:i},{data:a}]=await Promise.all([n.from("scroll_sessions").select("site, meters_scrolled").eq("user_id",e).gte("created_at",t),n.from("profiles").select("total_meters_scrolled").eq("id",e).single()]),c=Tt(i??[]),m=Number((a==null?void 0:a.total_meters_scrolled)??0);Ue(e,s,{todayMeters:parseFloat(c.todayMeters.toFixed(2)),todayBysite:c.todayBysite,totalMeters:parseFloat(m.toFixed(2))})})().finally(()=>{O.delete(e)});return O.set(e,o),o}async function Nt(e,s,t,r){const o=await ve();if(!o)return;const n=ge(),i=await gt({userId:o,site:e,meters:s,timestamp:t},n);if(i.length!==0){for(const a of i)n.achievementToast&&typeof r=="number"&&chrome.tabs.sendMessage(r,{type:"ACHIEVEMENT_TOAST",payload:a.toast}).catch(()=>{}),await Xe(a);J()}}function Ft(e,s,t){var r;switch(e.type){case"SCROLL_UPDATE":{const{site:o,pixels:n,meters:i,timestamp:a}=e.payload,c=D(o);return!c||!Number.isFinite(n)||!Number.isFinite(i)||n<=0||i<=0?(t({ok:!1}),!1):(Te(c,n,i),st(),Nt(c,i,a,(r=s.tab)==null?void 0:r.id),t({ok:!0}),!1)}case"GET_STATS":return Et().then(t).catch(()=>{t({todayMeters:0,todayBysite:{},totalMeters:0})}),!0;case"GET_BATTLE_TIMER":return ve().then(o=>o?At(o):{active:!1}).then(t).catch(()=>{t({active:!1})}),!0;default:return!1}}async function Et(){const e=Fe();let s=0;const t={};for(const[d,_]of e){const v=D(d);v&&(s+=_.totalMeters,t[v]=(t[v]??0)+_.totalMeters)}const r=h(),{data:{session:o}}=await r.auth.getSession();if(!o)return{todayMeters:parseFloat(s.toFixed(2)),todayBysite:t,totalMeters:parseFloat(s.toFixed(2))};const n=o.user.id,i=fe(),a=Ce();let c=U(n,i);const m=c.updatedAt===0,f=Date.now()-c.updatedAt>St;m?await Promise.race([ue(n,i,a),Mt(ht)]):f&&ue(n,i,a),c=U(n,i);const l={...c.todayBysite};for(const[d,_]of Object.entries(t))l[d]=(l[d]??0)+_;const y=c.todayMeters+s,u=c.totalMeters+s;return{todayMeters:parseFloat(y.toFixed(2)),todayBysite:l,totalMeters:parseFloat(u.toFixed(2))}}console.log("[DoomScroller] Background service worker loaded");Ne();Ye();chrome.runtime.onInstalled.addListener(()=>{console.log("[DoomScroller] Extension installed"),Me()});Me();G();W();chrome.runtime.onMessage.addListener(Ft);chrome.alarms.onAlarm.addListener(tt);
