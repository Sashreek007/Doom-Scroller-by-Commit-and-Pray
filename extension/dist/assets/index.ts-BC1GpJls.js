import{c as Ae,e as Z}from"./profile-DccX_sEz.js";import{t as I,a as Te}from"./constants-BqRKAH88.js";const $="scrollBatches",P="scrollBatchesInFlight";let _=new Map,S=new Map;function E(e){return{...e}}function F(e,s){for(const t of s){const o=e.get(t.site);o?(o.totalPixels+=t.totalPixels,o.totalMeters+=t.totalMeters,o.sessionStart=Math.min(o.sessionStart,t.sessionStart),o.lastUpdate=Math.max(o.lastUpdate,t.lastUpdate)):e.set(t.site,E(t))}}function X(e){if(!e||typeof e!="object")return new Map;const s=Object.entries(e);return new Map(s.map(([t,o])=>[t,E(o)]))}function Be(e,s,t){const o=_.get(e);o?(o.totalPixels+=s,o.totalMeters+=t,o.lastUpdate=Date.now()):_.set(e,{site:e,totalPixels:s,totalMeters:t,sessionStart:Date.now(),lastUpdate:Date.now()}),T()}async function T(){await chrome.storage.local.set({[$]:Object.fromEntries(_),[P]:Object.fromEntries(S)})}async function Ne(){const e=await chrome.storage.local.get([$,P]);_=X(e[$]),S=X(e[P]),S.size>0&&(F(_,S.values()),S.clear(),await T())}function Ee(){const e=new Map;return F(e,_.values()),F(e,S.values()),e}function Fe(e){F(_,e);for(const s of e)S.delete(s.site);T()}function De(){if(S.size>0)return[];const e=Array.from(_.values()).filter(s=>s.totalPixels>0).map(E);return e.length===0||(S=new Map(e.map(s=>[s.site,E(s)])),_.clear(),T()),e}function Ke(e){for(const s of e)S.delete(s.site);T()}let k=null;const Ie="https://aknzrsgymehrixfwqefq.supabase.co",Le="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrbnpyc2d5bWVocml4ZndxZWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMjUyODgsImV4cCI6MjA4NjYwMTI4OH0.ESpNDYKwlK72Ebj19yk5qoUDtOr3PY_rQ5dQSelwZL8",ke={getItem:async e=>{const t=(await chrome.storage.local.get(e))[e];if(t==null)return null;if(typeof t=="string")return t;try{return JSON.stringify(t)}catch{return null}},setItem:async(e,s)=>{await chrome.storage.local.set({[e]:s})},removeItem:async e=>{await chrome.storage.local.remove(e)}};async function Oe(e,s,t){var n;const o=`doomscroller:${e}`,r=(n=globalThis.navigator)==null?void 0:n.locks;if(!(r!=null&&r.request))return t();try{return await r.request(o,{mode:"exclusive"},async()=>t())}catch{return t()}}var me,ye;const Re=!!((ye=(me=globalThis.navigator)==null?void 0:me.locks)!=null&&ye.request);function M(){return k||(k=Ae(Ie,Le,{auth:{storage:ke,persistSession:!0,autoRefreshToken:Re,lock:Oe,detectSessionInUrl:!1}})),k}const A=new Map;function fe(e){const s=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${s}-${t}-${o}`}function Ue(e){return fe(new Date(e))}function pe(){return fe(new Date)}function Ce(){const e=new Date;return e.setHours(0,0,0,0),e.toISOString()}function D(e,s){const t=A.get(e);if(!t)return{dayKey:s,todayMeters:0,todayBysite:{},totalMeters:0,totalBysite:{},allTimeBysiteUpdatedAt:0,updatedAt:0};if(t.dayKey!==s){const o={...t,dayKey:s,todayMeters:0,todayBysite:{}};return A.set(e,o),o}return t}function $e(e,s,t,o){const r=A.get(e);A.set(e,{dayKey:s,todayMeters:t.todayMeters,todayBysite:{...t.todayBysite},totalMeters:t.totalMeters,totalBysite:{...t.totalBysite},allTimeBysiteUpdatedAt:o??(r==null?void 0:r.allTimeBysiteUpdatedAt)??0,updatedAt:Date.now()})}function Pe(e,s){const t=pe(),o=D(e,t),r={...o,todayBysite:{...o.todayBysite},totalBysite:{...o.totalBysite}};for(const n of s){const i=Number(n.totalMeters||0);if(!Number.isFinite(i)||i<=0)continue;r.totalMeters+=i;const a=I(n.site);a&&(r.totalBysite[a]=(r.totalBysite[a]??0)+i,Ue(n.lastUpdate)===t&&(r.todayMeters+=i,r.todayBysite[a]=(r.todayBysite[a]??0)+i))}r.updatedAt=Date.now(),A.set(e,r)}const Y="doomscroller_feature_flags",B={aiAchievements:!0,chatV2:!0,achievementToast:!0};function ge(e){const s=e&&typeof e=="object"?e:{};return{aiAchievements:typeof s.aiAchievements=="boolean"?s.aiAchievements:B.aiAchievements,chatV2:typeof s.chatV2=="boolean"?s.chatV2:B.chatV2,achievementToast:typeof s.achievementToast=="boolean"?s.achievementToast:B.achievementToast}}let J={...B},ee=!1;function Ye(e,s){if(s!=="local")return;const t=e[Y];t&&(J=ge(t.newValue))}async function Ve(){if(ee)return;ee=!0;const e=await chrome.storage.local.get(Y);J=ge(e[Y]),chrome.storage.onChanged.addListener(Ye)}function Se(){return J}const V="achievementJobsQueue",te=[2e3,1e4,3e4,12e4,3e5],qe=2e3;let v=[],se=!1,O=!1,oe=0;function p(e,s,t){const o=String(e??"").trim();return o?o.slice(0,s):t}function ze(e){const s=Math.min(Math.max(e-1,0),te.length-1);return te[s]}function xe(e){return e==="legendary"||e==="epic"||e==="rare"?e:"common"}function We(e){return Array.isArray(e)?e.filter(t=>!!t&&typeof t=="object").map(t=>t).filter(t=>typeof t.userId=="string"&&typeof t.eventKey=="string").map(t=>{var o,r,n,i,a,c,y,f,l,m,u,d,w,g,h,b;return{userId:String(t.userId),eventKey:String(t.eventKey),trigger:{type:p(String(((o=t.trigger)==null?void 0:o.type)??"scroll_pattern"),64,"scroll_pattern"),value:Number(((r=t.trigger)==null?void 0:r.value)??0),site:(n=t.trigger)!=null&&n.site?String(t.trigger.site).toLowerCase():null,timestamp:Number(((i=t.trigger)==null?void 0:i.timestamp)??Date.now())},runtimeSnapshot:{dayKey:p(String(((a=t.runtimeSnapshot)==null?void 0:a.dayKey)??""),32,""),todayMeters:Number(((c=t.runtimeSnapshot)==null?void 0:c.todayMeters)??0),todayBySite:(y=t.runtimeSnapshot)!=null&&y.todayBySite&&typeof t.runtimeSnapshot.todayBySite=="object"?Object.fromEntries(Object.entries(t.runtimeSnapshot.todayBySite).filter(([,L])=>Number.isFinite(L)).map(([L,be])=>[L,Number(be)])):{},rolling30Meters:Number(((f=t.runtimeSnapshot)==null?void 0:f.rolling30Meters)??0),sessionMeters:Number(((l=t.runtimeSnapshot)==null?void 0:l.sessionMeters)??0),sessionDurationSec:Number(((m=t.runtimeSnapshot)==null?void 0:m.sessionDurationSec)??0)},toast:{title:p(String(((u=t.toast)==null?void 0:u.title)??"Doom Achievement"),64,"Doom Achievement"),description:p(String(((d=t.toast)==null?void 0:d.description)??""),200,""),icon:p(String(((w=t.toast)==null?void 0:w.icon)??"ðŸ†"),4,"ðŸ†"),rarity:xe((g=t.toast)==null?void 0:g.rarity),roastLine:p(String(((h=t.toast)==null?void 0:h.roastLine)??""),220,""),appScope:(b=t.toast)!=null&&b.appScope?String(t.toast.appScope):null},meta:t.meta&&typeof t.meta=="object"?t.meta:{},attempt:Number(t.attempt??0),nextAttemptAt:Number(t.nextAttemptAt??Date.now()),createdAt:Number(t.createdAt??Date.now())}}).filter(t=>Number.isFinite(t.nextAttemptAt)&&Number.isFinite(t.createdAt)):[]}async function he(){if(se)return;const e=await chrome.storage.local.get(V);v=We(e[V]),se=!0}async function _e(){await chrome.storage.local.set({[V]:v})}function Je(e){return`${e.userId}::${e.eventKey}`}function Ge(e,s){const t=`${e}::${s}`;return v.some(o=>Je(o)===t)}function He(e){return{user_id:e.userId,trigger_type:p(e.trigger.type,64,"scroll_pattern"),trigger_value:Number.isFinite(e.trigger.value)?Number(e.trigger.value):0,title:p(e.toast.title,64,"Doom Achievement"),description:p(e.toast.description||e.toast.roastLine,180,"You unlocked a doomscroll achievement."),icon:p(e.toast.icon,4,"ðŸ†"),earned_at:new Date().toISOString(),event_key:p(e.eventKey,180,`event_${Date.now()}`),rarity:e.toast.rarity,app_scope:e.toast.appScope??e.trigger.site,meta:{roast_line:e.toast.roastLine,trigger:e.trigger,runtime_snapshot:e.runtimeSnapshot,rule_meta:e.meta},source:"rule"}}async function re(e){const s=M(),t=He(e),o=await s.from("achievements").insert(t).select("id").single();if(!o.error)return o.data??null;const r=o.error.message.toLowerCase();if(r.includes("duplicate key")){const n=await s.from("achievements").select("id").eq("user_id",e.userId).eq("event_key",t.event_key).order("earned_at",{ascending:!1}).limit(1).maybeSingle();if(!n.error)return n.data??null}if(r.includes("event_key")||r.includes("rarity")||r.includes("app_scope")||r.includes("meta")){const n=await s.from("achievements").insert({user_id:e.userId,trigger_type:t.trigger_type,trigger_value:t.trigger_value,title:t.title,description:t.description,icon:t.icon,earned_at:t.earned_at}).select("id").single();if(!n.error)return n.data??null}throw o.error}async function je(e){const s=M(),{data:{session:t}}=await s.auth.getSession(),o=(t==null?void 0:t.access_token)??"",r=await s.functions.invoke("generate-achievement",{body:{eventKey:e.eventKey,trigger:e.trigger,runtimeSnapshot:e.runtimeSnapshot,accessToken:o},headers:o?{Authorization:`Bearer ${o}`,"x-ds-token":o}:void 0});if(r.error)throw r.error;const n=r.data;return(n==null?void 0:n.achievement)??null}async function Qe(e){if(!Se().aiAchievements)return re(e);try{return await je(e)}catch(t){const o=t instanceof Error?t.message.toLowerCase():"";if(o.includes("function")||o.includes("404")||o.includes("network")||o.includes("failed to fetch"))return re(e);throw t}}function Ze(e){e.attempt+=1,e.nextAttemptAt=Date.now()+ze(e.attempt)}function Xe(e,s){chrome.runtime.sendMessage({type:"ACHIEVEMENT_SYNCED",payload:{userId:e.userId,eventKey:e.eventKey,achievementId:s}}).catch(()=>{})}async function et(e){await he(),!Ge(e.userId,e.eventKey)&&(v.push({userId:e.userId,eventKey:e.eventKey,trigger:e.trigger,runtimeSnapshot:e.runtimeSnapshot,toast:e.toast,meta:e.meta,attempt:0,nextAttemptAt:Date.now(),createdAt:Date.now()}),await _e())}async function G(){var e;if(!O){O=!0;try{if(await he(),v.length===0)return;const s=M(),{data:{session:t}}=await s.auth.getSession();if(!((e=t==null?void 0:t.user)!=null&&e.id))return;const o=Date.now(),r=t.user.id,n=[];for(const i of v){if(i.userId!==r){n.push(i);continue}if(i.nextAttemptAt>o){n.push(i);continue}try{const a=await Qe(i);Xe(i,a==null?void 0:a.id)}catch{Ze(i),n.push(i)}}v=n,await _e()}finally{O=!1}}}function H(){const e=Date.now();e-oe<qe||(oe=e,G())}const Me="sync-scroll",tt=5e3;let N=!1,ne=0;function ve(){chrome.alarms.create(Me,{periodInMinutes:Te})}function st(e){e.name===Me&&(j(),G())}function ot(){const e=Date.now();H(),!N&&(e-ne<tt||(ne=e,j()))}function rt(e){const s=e.toLowerCase();return s.includes("foreign key")&&s.includes("scroll_sessions_user_id_fkey")}async function j(){if(N)return;N=!0;const e=M();try{const{data:{session:s}}=await e.auth.getSession();if(!s)return;await Z(e,s.user);const t=De();if(t.length===0)return;const o=t.map(n=>({user_id:s.user.id,site:n.site,pixels_scrolled:Math.round(n.totalPixels),meters_scrolled:parseFloat(n.totalMeters.toFixed(4)),duration_seconds:Math.round((n.lastUpdate-n.sessionStart)/1e3),session_start:new Date(n.sessionStart).toISOString(),session_end:new Date(n.lastUpdate).toISOString()}));let{error:r}=await e.from("scroll_sessions").insert(o);r&&rt(r.message)&&(await Z(e,s.user),r=(await e.from("scroll_sessions").insert(o)).error),r?(console.error("[DoomScroller] Sync failed:",r.message),Fe(t)):(Pe(s.user.id,t),Ke(t),console.log(`[DoomScroller] Synced ${o.length} session(s) to Supabase`))}finally{N=!1,H()}}function ie(e,s){if(s<=0)return{site:null,share:0};const t=Object.entries(e).sort((o,r)=>r[1]-o[1]);return t.length===0?{site:null,share:0}:{site:t[0][0],share:t[0][1]/s}}function nt(e){const s=[],t=[100,250,500,1e3,2e3];for(const l of t)e.previousTodayMeters<l&&e.todayMeters>=l&&s.push({eventKey:`daily_distance_${l}_${e.dayKey}`,triggerType:"daily_distance_threshold",triggerValue:l,title:`${l}m Regret`,description:`You crossed ${l}m today. Productivity remains theoretical.`,icon:l>=1e3?"ðŸ”¥":"ðŸ†",rarity:l>=1e3?"epic":l>=500?"rare":"common",appScope:null,roastLine:"Your thumb is building endurance faster than your assignments.",meta:{threshold:l,dayKey:e.dayKey}});const o=ie(e.previousTodayBySite,e.previousTodayMeters),r=ie(e.todayBySite,e.todayMeters),n=o.site&&o.share>=.75&&e.previousTodayMeters>=180,i=r.site&&r.share>=.75&&e.todayMeters>=180;!n&&i&&r.site&&s.push({eventKey:`app_specialist_${r.site}_${e.dayKey}`,triggerType:"app_specialist",triggerValue:Number((r.share*100).toFixed(2)),title:`${r.site.toUpperCase()} Loyalist`,description:`${Math.round(r.share*100)}% of today's scroll happened on ${r.site}.`,icon:"ðŸ“±",rarity:"epic",appScope:r.site,roastLine:`You didn't browse apps. You moved into ${r.site}.`,meta:{share:Number(r.share.toFixed(4))}});const a=Object.keys(e.previousTodayBySite).filter(l=>e.previousTodayBySite[l]>0).length,c=Object.keys(e.todayBySite).filter(l=>e.todayBySite[l]>0).length;a<4&&c>=4&&e.todayMeters>=200&&s.push({eventKey:`app_diversity_4_${e.dayKey}`,triggerType:"app_diversity",triggerValue:c,title:"Multi-Feed Tourist",description:`You sampled ${c} apps today. Procrastination buffet unlocked.`,icon:"ðŸŒ€",rarity:"rare",appScope:null,roastLine:"You diversified your distraction portfolio.",meta:{uniqueSites:c}}),e.previousRolling30Meters<40&&e.rolling30Meters>=40&&s.push({eventKey:`burst_scroll_${e.dayKey}`,triggerType:"burst_scroll",triggerValue:Number(e.rolling30Meters.toFixed(2)),title:"Doom Sprint",description:`${Math.round(e.rolling30Meters)}m in 30s. Your thumb is speedrunning.`,icon:"âš¡",rarity:"rare",appScope:e.site,roastLine:"That burst had more urgency than your deadlines.",meta:{windowSeconds:30}});const y=e.previousSessionDurationSec>=20*60&&e.previousSessionMeters>=250,f=e.sessionDurationSec>=20*60&&e.sessionMeters>=250;return!y&&f&&s.push({eventKey:`session_marathon_${e.dayKey}`,triggerType:"session_marathon",triggerValue:Number(e.sessionMeters.toFixed(2)),title:"Infinite Scroll Endurance",description:`You survived a ${Math.round(e.sessionDurationSec/60)} min doom session.`,icon:"ðŸ”¥",rarity:"epic",appScope:r.site??e.site,roastLine:"Your stamina is impressive and deeply concerning.",meta:{sessionDurationSec:Math.round(e.sessionDurationSec)}}),s}const it="achievementRuntimeState:",at=5*60*1e3,ct=30*1e3,q=400,lt=1200,K=new Map,R=new Map,ae=new Set,U=new Map;function z(e){return`${it}${e}`}function Q(e){const s=new Date(e),t=s.getFullYear(),o=String(s.getMonth()+1).padStart(2,"0"),r=String(s.getDate()).padStart(2,"0");return`${t}-${o}-${r}`}function x(e){return{dayKey:Q(e),todayMeters:0,todayBySite:{},rollingWindow:[],sessionStartTs:e,sessionMeters:0,lastScrollTs:e,unlockedEventKeys:[]}}function ut(e,s){if(!e||typeof e!="object")return x(s);const t=e,o=x(s);return typeof t.dayKey=="string"&&(o.dayKey=t.dayKey),Number.isFinite(t.todayMeters)&&(o.todayMeters=Number(t.todayMeters)),t.todayBySite&&typeof t.todayBySite=="object"&&(o.todayBySite=Object.fromEntries(Object.entries(t.todayBySite).filter(([,r])=>Number.isFinite(r)).map(([r,n])=>[r,Number(n)]))),Array.isArray(t.rollingWindow)&&(o.rollingWindow=t.rollingWindow.filter(r=>!!r&&typeof r=="object").map(r=>({timestamp:Number(r.timestamp??0),meters:Number(r.meters??0),site:String(r.site??"unknown").toLowerCase()})).filter(r=>Number.isFinite(r.timestamp)&&Number.isFinite(r.meters)&&r.meters>0)),Number.isFinite(t.sessionStartTs)&&(o.sessionStartTs=Number(t.sessionStartTs)),Number.isFinite(t.sessionMeters)&&(o.sessionMeters=Number(t.sessionMeters)),Number.isFinite(t.lastScrollTs)&&(o.lastScrollTs=Number(t.lastScrollTs)),Array.isArray(t.unlockedEventKeys)&&(o.unlockedEventKeys=t.unlockedEventKeys.map(r=>String(r)).filter(r=>r.length>0).slice(-q)),o}function dt(e,s){const t=K.get(e);if(t)return t;const o=x(s);return K.set(e,o),o}function mt(e){if(U.has(e))return;const s=setTimeout(()=>{U.delete(e);const t=K.get(e);t&&chrome.storage.local.set({[z(e)]:t})},lt);U.set(e,s)}async function yt(e,s){if(ae.has(e))return;const t=R.get(e);if(t){await t;return}const o=(async()=>{const r=await chrome.storage.local.get(z(e)),n=ut(r[z(e)],s),i=Q(s);n.dayKey!==i&&(n.dayKey=i,n.todayMeters=0,n.todayBySite={},n.rollingWindow=[],n.sessionStartTs=s,n.sessionMeters=0),K.set(e,n),ae.add(e)})().finally(()=>{R.delete(e)});R.set(e,o),await o}function ce(e,s){const t=s-ct;e.rollingWindow=e.rollingWindow.filter(o=>o.timestamp>=t)}function W(e){return e.rollingWindow.reduce((s,t)=>s+t.meters,0)}function ft(e,s){const t=Math.max(0,(s-e.sessionStartTs)/1e3);return{dayKey:e.dayKey,todayMeters:Number(e.todayMeters.toFixed(2)),todayBySite:{...e.todayBySite},rolling30Meters:Number(W(e).toFixed(2)),sessionMeters:Number(e.sessionMeters.toFixed(2)),sessionDurationSec:Number(t.toFixed(2))}}function pt(e){return{eventKey:e.eventKey,title:e.title,description:e.description,icon:e.icon,rarity:e.rarity,roastLine:e.roastLine,appScope:e.appScope}}function gt(e,s){return e.unlockedEventKeys.includes(s)?!1:(e.unlockedEventKeys.push(s),e.unlockedEventKeys.length>q&&(e.unlockedEventKeys=e.unlockedEventKeys.slice(-q)),!0)}async function St(e,s){if(!s.aiAchievements&&!s.achievementToast)return[];const t=Number(e.meters);if(!Number.isFinite(t)||t<=0)return[];await yt(e.userId,e.timestamp);const o=dt(e.userId,e.timestamp),r=Q(e.timestamp);o.dayKey!==r&&(o.dayKey=r,o.todayMeters=0,o.todayBySite={},o.rollingWindow=[],o.sessionStartTs=e.timestamp,o.sessionMeters=0),e.timestamp-o.lastScrollTs>at&&(o.sessionStartTs=e.timestamp,o.sessionMeters=0,o.rollingWindow=[]),ce(o,e.timestamp);const n=W(o),i=o.todayMeters,a={...o.todayBySite},c=o.sessionMeters,y=Math.max(0,(e.timestamp-o.sessionStartTs)/1e3);o.todayMeters+=t,o.todayBySite[e.site]=(o.todayBySite[e.site]??0)+t,o.sessionMeters+=t,o.lastScrollTs=e.timestamp,o.rollingWindow.push({timestamp:e.timestamp,meters:t,site:e.site}),ce(o,e.timestamp);const f=W(o),l=Math.max(0,(e.timestamp-o.sessionStartTs)/1e3),m=nt({dayKey:o.dayKey,site:e.site,timestamp:e.timestamp,todayMeters:o.todayMeters,todayBySite:o.todayBySite,rolling30Meters:f,sessionMeters:o.sessionMeters,sessionDurationSec:l,previousTodayMeters:i,previousTodayBySite:a,previousRolling30Meters:n,previousSessionMeters:c,previousSessionDurationSec:y}),u=[];for(const d of m)gt(o,d.eventKey)&&u.push({userId:e.userId,eventKey:d.eventKey,trigger:{type:d.triggerType,value:d.triggerValue,site:d.appScope,timestamp:e.timestamp},toast:pt(d),runtimeSnapshot:ft(o,e.timestamp),meta:d.meta});return mt(e.userId),u}const ht=5e3,_t=6e4,Mt=250,vt=400,C=new Map,le=new Map;function wt(e){return new Promise(s=>setTimeout(s,e))}async function we(){var t;const e=M(),{data:{session:s}}=await e.auth.getSession();return((t=s==null?void 0:s.user)==null?void 0:t.id)??null}async function bt(e){const s=M(),{error:t}=await s.rpc("finalize_battle_round",{p_room_id:e});if(!t)return;const o=(t.message??"").toLowerCase();o.includes("round is not active")||o.includes("round timer has not completed")||o.includes("room not found")}function At(e){if(!e.round_result||typeof e.round_result!="object")return null;const s=e.round_result,t=typeof s.settledAt=="string"?s.settledAt:null,o=Number(s.pot),r=Number(s.betCoins);if(!t||!Number.isFinite(o)||!Number.isFinite(r))return null;const n=Array.isArray(s.winnerIds)?s.winnerIds.filter(a=>typeof a=="string"):[],i={};if(s.payouts&&typeof s.payouts=="object")for(const[a,c]of Object.entries(s.payouts)){const y=Number(c);Number.isFinite(y)&&(i[a]=y)}return{roomId:typeof e.id=="string"?e.id:"",roomKey:typeof e.room_key=="string"?e.room_key:"",gameType:typeof e.selected_game_type=="string"?e.selected_game_type:null,settledAt:t,winnerIds:n,payouts:i,pot:Math.max(0,Math.floor(o)),betCoins:Math.max(0,Math.floor(r))}}async function Tt(e){const s=M(),{data:t,error:o}=await s.from("battle_room_members").select("room_id, joined_at").eq("user_id",e).eq("status","joined").order("joined_at",{ascending:!1}).limit(12);if(o)return{active:!1,viewerUserId:e};const r=(t??[]).map(u=>u.room_id).filter(u=>!!u);if(r.length===0)return{active:!1,viewerUserId:e};const n="id, room_key, host_id, status, selected_game_type, round_started_at, round_ends_at, timer_seconds, round_result, updated_at",{data:i,error:a}=await s.from("battle_rooms").select(n).in("id",r).order("updated_at",{ascending:!1});if(a||!i||i.length===0)return{active:!1,viewerUserId:e};let c=i;const y=Date.now(),f=c.find(u=>{if(u.status!=="active"||!u.round_ends_at)return!1;const d=Date.parse(u.round_ends_at);return Number.isFinite(d)&&d<=y});if(f!=null&&f.id){await bt(f.id);const{data:u}=await s.from("battle_rooms").select(n).in("id",r).order("updated_at",{ascending:!1});u!=null&&u.length&&(c=u)}let l=null;for(const u of c){const d=At(u);if(d){l=d;break}}const m=c.find(u=>{if(u.status!=="active"||!u.round_started_at||!u.round_ends_at)return!1;const d=Date.parse(u.round_ends_at);return Number.isFinite(d)&&d>y});return m?{active:!0,viewerUserId:e,roomId:m.id,roomKey:m.room_key,gameType:m.selected_game_type??null,roundStartedAt:m.round_started_at,roundEndsAt:m.round_ends_at,timerSeconds:Number(m.timer_seconds??0),latestRoundResult:l}:{active:!1,viewerUserId:e,latestRoundResult:l}}async function Bt(e){const s=le.get(e),t=Date.now();if(s&&t-s.updatedAt<vt)if(s.value.active){const r=Date.parse(s.value.roundEndsAt??"");if(!(Number.isFinite(r)&&r<=t))return s.value}else return s.value;const o=await Tt(e);return le.set(e,{updatedAt:t,value:o}),o}function ue(e){const s={};let t=0;for(const o of e){const r=I(o.site);if(!r)continue;const n=Number(o.meters_scrolled??0);Number.isFinite(n)&&(t+=n,s[r]=(s[r]??0)+n)}return{totalMeters:t,bySite:s}}function de(e,s,t,o){const r=C.get(e);if(r)return r;const n=(async()=>{const i=M(),a=D(e,s),[{data:c},{data:y},{data:f}]=await Promise.all([i.from("scroll_sessions").select("site, meters_scrolled").eq("user_id",e).gte("created_at",t),i.from("profiles").select("total_meters_scrolled").eq("id",e).single(),o?i.from("scroll_sessions").select("site, meters_scrolled").eq("user_id",e):Promise.resolve({data:null})]),l=ue(c??[]),m=o?ue(f??[]):null,u=Number((y==null?void 0:y.total_meters_scrolled)??0);$e(e,s,{todayMeters:parseFloat(l.totalMeters.toFixed(2)),todayBysite:l.bySite,totalMeters:parseFloat(u.toFixed(2)),totalBysite:(m==null?void 0:m.bySite)??a.totalBysite},o?Date.now():void 0)})().finally(()=>{C.delete(e)});return C.set(e,n),n}async function Nt(e,s,t,o){const r=await we();if(!r)return;const n=Se(),i=await St({userId:r,site:e,meters:s,timestamp:t},n);if(i.length!==0){for(const a of i)n.achievementToast&&typeof o=="number"&&chrome.tabs.sendMessage(o,{type:"ACHIEVEMENT_TOAST",payload:a.toast}).catch(()=>{}),await et(a);H()}}function Et(e,s,t){var o;switch(e.type){case"SCROLL_UPDATE":{const{site:r,pixels:n,meters:i,timestamp:a}=e.payload,c=I(r);return!c||!Number.isFinite(n)||!Number.isFinite(i)||n<=0||i<=0?(t({ok:!1}),!1):(Be(c,n,i),ot(),Nt(c,i,a,(o=s.tab)==null?void 0:o.id),t({ok:!0}),!1)}case"GET_STATS":return Ft().then(t).catch(()=>{t({todayMeters:0,todayBysite:{},totalMeters:0,totalBysite:{}})}),!0;case"GET_BATTLE_TIMER":return we().then(r=>r?Bt(r):{active:!1}).then(t).catch(()=>{t({active:!1})}),!0;default:return!1}}async function Ft(){const e=Ee();let s=0;const t={};for(const[g,h]of e){const b=I(g);b&&(s+=h.totalMeters,t[b]=(t[b]??0)+h.totalMeters)}const o=M(),{data:{session:r}}=await o.auth.getSession();if(!r)return{todayMeters:parseFloat(s.toFixed(2)),todayBysite:t,totalMeters:parseFloat(s.toFixed(2)),totalBysite:t};const n=r.user.id,i=pe(),a=Ce();let c=D(n,i);const y=c.updatedAt===0,f=Date.now()-c.updatedAt>ht,l=c.allTimeBysiteUpdatedAt===0||Date.now()-c.allTimeBysiteUpdatedAt>_t;y?await Promise.race([de(n,i,a,!0),wt(Mt)]):(f||l)&&de(n,i,a,l),c=D(n,i);const m={...c.todayBysite};for(const[g,h]of Object.entries(t))m[g]=(m[g]??0)+h;const u=c.todayMeters+s,d=c.totalMeters+s,w={...c.totalBysite};for(const[g,h]of Object.entries(t))w[g]=(w[g]??0)+h;return{todayMeters:parseFloat(u.toFixed(2)),todayBysite:m,totalMeters:parseFloat(d.toFixed(2)),totalBysite:w}}console.log("[DoomScroller] Background service worker loaded");Ne();Ve();chrome.runtime.onInstalled.addListener(()=>{console.log("[DoomScroller] Extension installed"),ve()});ve();j();G();chrome.runtime.onMessage.addListener(Et);chrome.alarms.onAlarm.addListener(st);
