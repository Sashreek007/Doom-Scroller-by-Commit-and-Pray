import{c as U,e as x}from"./profile-DccX_sEz.js";import{a as P,t as w}from"./constants-DnDMOe8K.js";const M="scrollBatches",I="scrollBatchesInFlight";let l=new Map,n=new Map;function g(e){return{...e}}function y(e,t){for(const s of t){const o=e.get(s.site);o?(o.totalPixels+=s.totalPixels,o.totalMeters+=s.totalMeters,o.sessionStart=Math.min(o.sessionStart,s.sessionStart),o.lastUpdate=Math.max(o.lastUpdate,s.lastUpdate)):e.set(s.site,g(s))}}function N(e){if(!e||typeof e!="object")return new Map;const t=Object.entries(e);return new Map(t.map(([s,o])=>[s,g(o)]))}function v(e,t,s){const o=l.get(e);o?(o.totalPixels+=t,o.totalMeters+=s,o.lastUpdate=Date.now()):l.set(e,{site:e,totalPixels:t,totalMeters:s,sessionStart:Date.now(),lastUpdate:Date.now()}),m()}async function m(){await chrome.storage.local.set({[M]:Object.fromEntries(l),[I]:Object.fromEntries(n)})}async function L(){const e=await chrome.storage.local.get([M,I]);l=N(e[M]),n=N(e[I]),n.size>0&&(y(l,n.values()),n.clear(),await m())}function C(){const e=new Map;return y(e,l.values()),y(e,n.values()),e}function Y(e){y(l,e);for(const t of e)n.delete(t.site);m()}function j(){if(n.size>0)return[];const e=Array.from(l.values()).filter(t=>t.totalPixels>0).map(g);return e.length===0||(n=new Map(e.map(t=>[t.site,g(t)])),l.clear(),m()),e}function k(e){for(const t of e)n.delete(t.site);m()}let h=null;const q="https://aknzrsgymehrixfwqefq.supabase.co",z="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrbnpyc2d5bWVocml4ZndxZWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMjUyODgsImV4cCI6MjA4NjYwMTI4OH0.ESpNDYKwlK72Ebj19yk5qoUDtOr3PY_rQ5dQSelwZL8",J={getItem:async e=>(await chrome.storage.local.get(e))[e]??null,setItem:async(e,t)=>{await chrome.storage.local.set({[e]:t})},removeItem:async e=>{await chrome.storage.local.remove(e)}};function b(){return h||(h=U(q,z,{auth:{storage:J,persistSession:!0,autoRefreshToken:!0,lock:async(e,t,s)=>await s(),detectSessionInUrl:!1}})),h}const B="sync-scroll",R=5e3;let p=!1,O=0;function T(){chrome.alarms.create(B,{periodInMinutes:P})}function Z(e){e.name===B&&F()}function K(){const e=Date.now();p||e-O<R||(O=e,F())}function G(e){const t=e.toLowerCase();return t.includes("foreign key")&&t.includes("scroll_sessions_user_id_fkey")}async function F(){if(p)return;p=!0;const e=b();try{const{data:{session:t}}=await e.auth.getSession();if(!t)return;await x(e,t.user);const s=j();if(s.length===0)return;const o=s.map(a=>({user_id:t.user.id,site:a.site,pixels_scrolled:Math.round(a.totalPixels),meters_scrolled:parseFloat(a.totalMeters.toFixed(4)),duration_seconds:Math.round((a.lastUpdate-a.sessionStart)/1e3),session_start:new Date(a.sessionStart).toISOString(),session_end:new Date(a.lastUpdate).toISOString()}));let{error:r}=await e.from("scroll_sessions").insert(o);r&&G(r.message)&&(await x(e,t.user),r=(await e.from("scroll_sessions").insert(o)).error),r?(console.error("[DoomScroller] Sync failed:",r.message),Y(s)):(k(s),console.log(`[DoomScroller] Synced ${o.length} session(s) to Supabase`))}finally{p=!1}}function V(e,t,s){switch(e.type){case"SCROLL_UPDATE":{const{site:o,pixels:r,meters:a}=e.payload,d=w(o);return!d||!Number.isFinite(r)||!Number.isFinite(a)||r<=0||a<=0?(s({ok:!1}),!1):(v(d,r,a),K(),s({ok:!0}),!1)}case"GET_STATS":return H().then(s).catch(()=>{s({todayMeters:0,todayBysite:{},totalMeters:0})}),!0;default:return!1}}async function H(){const e=C();let t=0;const s={};for(const[c,i]of e){const u=w(c);u&&(t+=i.totalMeters,s[u]=(s[u]??0)+i.totalMeters)}const o=b(),{data:{session:r}}=await o.auth.getSession();if(!r)return{todayMeters:parseFloat(t.toFixed(2)),todayBysite:s,totalMeters:parseFloat(t.toFixed(2))};const a=new Date;a.setHours(0,0,0,0);const{data:d}=await o.from("scroll_sessions").select("site, meters_scrolled").eq("user_id",r.user.id).gte("created_at",a.toISOString()),f={};let _=0;if(d)for(const c of d){const i=w(c.site);if(!i)continue;const u=Number(c.meters_scrolled);_+=u,f[i]=(f[i]??0)+u}for(const[c,i]of Object.entries(s))_+=i,f[c]=(f[c]??0)+i;const{data:A}=await o.from("profiles").select("total_meters_scrolled").eq("id",r.user.id).single(),E=A?Number(A.total_meters_scrolled):0,S=await Q(r.user.id),D=S??E;return S!==null&&Math.abs(S-E)>.01&&o.from("profiles").update({total_meters_scrolled:parseFloat(S.toFixed(2))}).eq("id",r.user.id),{todayMeters:parseFloat(_.toFixed(2)),todayBysite:f,totalMeters:parseFloat((D+t).toFixed(2))}}async function Q(e){const t=b(),{data:s,error:o}=await t.from("scroll_sessions").select("meters_scrolled").eq("user_id",e);return o||!s?null:s.reduce((r,a)=>r+Number(a.meters_scrolled??0),0)}console.log("[DoomScroller] Background service worker loaded");L();chrome.runtime.onInstalled.addListener(()=>{console.log("[DoomScroller] Extension installed"),T()});T();F();chrome.runtime.onMessage.addListener(V);chrome.alarms.onAlarm.addListener(Z);
