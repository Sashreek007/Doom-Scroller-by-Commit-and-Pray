import{c as Y,e as N}from"./profile-DccX_sEz.js";import{t as g,a as j}from"./constants-BqRKAH88.js";const B="scrollBatches",b="scrollBatchesInFlight";let d=new Map,c=new Map;function S(t){return{...t}}function p(t,e){for(const s of e){const o=t.get(s.site);o?(o.totalPixels+=s.totalPixels,o.totalMeters+=s.totalMeters,o.sessionStart=Math.min(o.sessionStart,s.sessionStart),o.lastUpdate=Math.max(o.lastUpdate,s.lastUpdate)):t.set(s.site,S(s))}}function T(t){if(!t||typeof t!="object")return new Map;const e=Object.entries(t);return new Map(e.map(([s,o])=>[s,S(o)]))}function k(t,e,s){const o=d.get(t);o?(o.totalPixels+=e,o.totalMeters+=s,o.lastUpdate=Date.now()):d.set(t,{site:t,totalPixels:e,totalMeters:s,sessionStart:Date.now(),lastUpdate:Date.now()}),u()}async function u(){await chrome.storage.local.set({[B]:Object.fromEntries(d),[b]:Object.fromEntries(c)})}async function z(){const t=await chrome.storage.local.get([B,b]);d=T(t[B]),c=T(t[b]),c.size>0&&(p(d,c.values()),c.clear(),await u())}function q(){const t=new Map;return p(t,d.values()),p(t,c.values()),t}function J(t){p(d,t);for(const e of t)c.delete(e.site);u()}function Z(){if(c.size>0)return[];const t=Array.from(d.values()).filter(e=>e.totalPixels>0).map(S);return t.length===0||(c=new Map(t.map(e=>[e.site,S(e)])),d.clear(),u()),t}function V(t){for(const e of t)c.delete(e.site);u()}let I=null;const G="https://aknzrsgymehrixfwqefq.supabase.co",H="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrbnpyc2d5bWVocml4ZndxZWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMjUyODgsImV4cCI6MjA4NjYwMTI4OH0.ESpNDYKwlK72Ebj19yk5qoUDtOr3PY_rQ5dQSelwZL8",$={getItem:async t=>(await chrome.storage.local.get(t))[t]??null,setItem:async(t,e)=>{await chrome.storage.local.set({[t]:e})},removeItem:async t=>{await chrome.storage.local.remove(t)}};function A(){return I||(I=Y(G,H,{auth:{storage:$,persistSession:!0,autoRefreshToken:!0,lock:async(t,e,s)=>await s(),detectSessionInUrl:!1}})),I}const M=new Map;function U(t){const e=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${e}-${s}-${o}`}function Q(t){return U(new Date(t))}function P(){return U(new Date)}function W(){const t=new Date;return t.setHours(0,0,0,0),t.toISOString()}function D(t,e){const s=M.get(t);if(!s)return{dayKey:e,todayMeters:0,todayBysite:{},totalMeters:0,updatedAt:0};if(s.dayKey!==e){const o={...s,dayKey:e,todayMeters:0,todayBysite:{}};return M.set(t,o),o}return s}function X(t,e,s){M.set(t,{dayKey:e,todayMeters:s.todayMeters,todayBysite:{...s.todayBysite},totalMeters:s.totalMeters,updatedAt:Date.now()})}function tt(t,e){const s=P(),o=D(t,s),n={...o,todayBysite:{...o.todayBysite}};for(const a of e){const r=Number(a.totalMeters||0);if(!(!Number.isFinite(r)||r<=0)&&(n.totalMeters+=r,Q(a.lastUpdate)===s)){const i=g(a.site);if(!i)continue;n.todayMeters+=r,n.todayBysite[i]=(n.todayBysite[i]??0)+r}}n.updatedAt=Date.now(),M.set(t,n)}const C="sync-scroll",et=5e3;let m=!1,x=0;function L(){chrome.alarms.create(C,{periodInMinutes:j})}function st(t){t.name===C&&E()}function ot(){const t=Date.now();m||t-x<et||(x=t,E())}function at(t){const e=t.toLowerCase();return e.includes("foreign key")&&e.includes("scroll_sessions_user_id_fkey")}async function E(){if(m)return;m=!0;const t=A();try{const{data:{session:e}}=await t.auth.getSession();if(!e)return;await N(t,e.user);const s=Z();if(s.length===0)return;const o=s.map(a=>({user_id:e.user.id,site:a.site,pixels_scrolled:Math.round(a.totalPixels),meters_scrolled:parseFloat(a.totalMeters.toFixed(4)),duration_seconds:Math.round((a.lastUpdate-a.sessionStart)/1e3),session_start:new Date(a.sessionStart).toISOString(),session_end:new Date(a.lastUpdate).toISOString()}));let{error:n}=await t.from("scroll_sessions").insert(o);n&&at(n.message)&&(await N(t,e.user),n=(await t.from("scroll_sessions").insert(o)).error),n?(console.error("[DoomScroller] Sync failed:",n.message),J(s)):(tt(e.user.id,s),V(s),console.log(`[DoomScroller] Synced ${o.length} session(s) to Supabase`))}finally{m=!1}}const nt=5e3,rt=250,F=new Map;function it(t){return new Promise(e=>setTimeout(e,t))}function ct(t){const e={};let s=0;for(const o of t){const n=g(o.site);if(!n)continue;const a=Number(o.meters_scrolled??0);Number.isFinite(a)&&(s+=a,e[n]=(e[n]??0)+a)}return{todayMeters:s,todayBysite:e}}function O(t,e,s){const o=F.get(t);if(o)return o;const n=(async()=>{const a=A(),[{data:r},{data:i}]=await Promise.all([a.from("scroll_sessions").select("site, meters_scrolled").eq("user_id",t).gte("created_at",s),a.from("profiles").select("total_meters_scrolled").eq("id",t).single()]),l=ct(r??[]),h=Number((i==null?void 0:i.total_meters_scrolled)??0);X(t,e,{todayMeters:parseFloat(l.todayMeters.toFixed(2)),todayBysite:l.todayBysite,totalMeters:parseFloat(h.toFixed(2))})})().finally(()=>{F.delete(t)});return F.set(t,n),n}function lt(t,e,s){switch(t.type){case"SCROLL_UPDATE":{const{site:o,pixels:n,meters:a}=t.payload,r=g(o);return!r||!Number.isFinite(n)||!Number.isFinite(a)||n<=0||a<=0?(s({ok:!1}),!1):(k(r,n,a),ot(),s({ok:!0}),!1)}case"GET_STATS":return dt().then(s).catch(()=>{s({todayMeters:0,todayBysite:{},totalMeters:0})}),!0;default:return!1}}async function dt(){const t=q();let e=0;const s={};for(const[f,y]of t){const _=g(f);_&&(e+=y.totalMeters,s[_]=(s[_]??0)+y.totalMeters)}const o=A(),{data:{session:n}}=await o.auth.getSession();if(!n)return{todayMeters:parseFloat(e.toFixed(2)),todayBysite:s,totalMeters:parseFloat(e.toFixed(2))};const a=n.user.id,r=P(),i=W();let l=D(a,r);const h=l.updatedAt===0,v=Date.now()-l.updatedAt>nt;h?await Promise.race([O(a,r,i),it(rt)]):v&&O(a,r,i),l=D(a,r);const w={...l.todayBysite};for(const[f,y]of Object.entries(s))w[f]=(w[f]??0)+y;const R=l.todayMeters+e,K=l.totalMeters+e;return{todayMeters:parseFloat(R.toFixed(2)),todayBysite:w,totalMeters:parseFloat(K.toFixed(2))}}console.log("[DoomScroller] Background service worker loaded");z();chrome.runtime.onInstalled.addListener(()=>{console.log("[DoomScroller] Extension installed"),L()});L();E();chrome.runtime.onMessage.addListener(lt);chrome.alarms.onAlarm.addListener(st);
